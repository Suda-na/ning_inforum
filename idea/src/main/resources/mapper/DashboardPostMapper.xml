<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.niit.dao.DashboardPostDao">
    
    <!-- 统计当日发布的内容数量 -->
    <select id="countTodayPosts" resultType="int">
        SELECT COUNT(*) 
        FROM post 
        WHERE DATE(create_time) = CURDATE()
          AND status != 2
    </select>
    
    <!-- 统计待处理举报数量 -->
    <select id="countPendingReports" resultType="int">
        SELECT COUNT(*) 
        FROM report 
        WHERE status = 0
    </select>
    
    <!-- 统计已封禁账号数量 -->
    <select id="countBannedUsers" resultType="int">
        SELECT COUNT(*) 
        FROM user 
        WHERE status = 1
    </select>
    
    <!-- 查询最近7天每日新增用户数量 -->
    <select id="getLast7DaysNewUsers" resultType="map">
        SELECT 
            DATE_FORMAT(date_val, '%m-%d') as `date`,
            CAST(COUNT(*) AS UNSIGNED) as `count`
        FROM (
            SELECT DATE(create_time) as date_val
            FROM user
            WHERE DATE(create_time) >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
              AND DATE(create_time) &lt;= CURDATE()
        ) as temp
        GROUP BY date_val
        ORDER BY date_val ASC
    </select>
    
    <!-- 查询最近7天每日互动数量 -->
    <select id="getLast7DaysInteractions" resultType="map">
        SELECT 
            DATE_FORMAT(date_val, '%m-%d') as `date`,
            CAST(COUNT(*) AS UNSIGNED) as `count`
        FROM (
            SELECT DATE(create_time) as date_val
            FROM interaction
            WHERE DATE(create_time) >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
              AND DATE(create_time) &lt;= CURDATE()
              AND status = 1
        ) as temp
        GROUP BY date_val
        ORDER BY date_val ASC
    </select>
    
    <!-- 查询最近7天每日新增举报数量 -->
    <select id="getLast7DaysNewReports" resultType="map">
        SELECT 
            DATE_FORMAT(date_val, '%m-%d') as `date`,
            CAST(COUNT(*) AS UNSIGNED) as `count`
        FROM (
            SELECT DATE(create_time) as date_val
            FROM report
            WHERE DATE(create_time) >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
              AND DATE(create_time) &lt;= CURDATE()
        ) as temp
        GROUP BY date_val
        ORDER BY date_val ASC
    </select>
    
    <!-- 查询各类型举报数量（用于风险雷达图） -->
    <select id="getReportTypeCounts" resultType="map">
        SELECT 
            report_type as `reportType`,
            CAST(COUNT(*) AS UNSIGNED) as `count`
        FROM report
        GROUP BY report_type
        ORDER BY 
            CASE report_type
                WHEN '垃圾信息' THEN 1
                WHEN '色情低俗' THEN 2
                WHEN '违法违规' THEN 3
                WHEN '欺诈' THEN 4
                WHEN '侵权' THEN 5
                WHEN '其他' THEN 6
                ELSE 7
            END
    </select>
    
    <!-- 查询各分类帖子数量（用于内容板块热度图） -->
    <select id="getCategoryPostCounts" resultType="map">
        SELECT 
            c.name as `categoryName`,
            CAST(COUNT(p.post_id) AS UNSIGNED) as `count`
        FROM category c
        LEFT JOIN post p ON c.category_id = p.category_id AND p.status != 2
        WHERE c.status = 1
        GROUP BY c.category_id, c.name
        ORDER BY c.sort_order ASC
    </select>
    
    <!-- 查询用户性别统计（用于用户性别构成图） -->
    <select id="getUserGenderCounts" resultType="map">
        SELECT 
            CAST(gender AS SIGNED) as `gender`,
            CAST(COUNT(*) AS UNSIGNED) as `count`
        FROM user
        WHERE status != 2
        GROUP BY gender
        ORDER BY 
            CASE gender
                WHEN 1 THEN 1
                WHEN 2 THEN 2
                WHEN 0 THEN 3
                ELSE 4
            END
    </select>
    
    <!-- 查询动态状态统计（用于动态状态统计图） -->
    <select id="getPostStatusCounts" resultType="map">
        SELECT 
            CAST(status AS SIGNED) as `status`,
            CAST(COUNT(*) AS UNSIGNED) as `count`
        FROM post
        WHERE status IN (0, 1, 4)
        GROUP BY status
        ORDER BY 
            CASE status
                WHEN 1 THEN 1
                WHEN 0 THEN 2
                WHEN 4 THEN 3
                ELSE 4
            END
    </select>

    <!-- 查询最新注册的用户列表（最新20条，用于大屏“最新用户”模块） -->
    <select id="getLatestUsers" resultType="map">
        SELECT
            u.user_id      AS `userId`,
            u.avatar       AS `avatar`,
            u.username     AS `username`,
            u.gender       AS `gender`,
            u.phone        AS `phone`,
            u.email        AS `email`,
            u.create_time  AS `createTime`,
            u.status       AS `status`
        FROM user u
        ORDER BY u.create_time DESC
        LIMIT 50
    </select>

    <!-- 查询封禁记录列表（最新50条，用于大屏“封禁记录”模块） -->
    <select id="getBanRecords" resultType="map">
        SELECT
            h.history_id      AS `historyId`,
            admin.username    AS `adminName`,
            u.username        AS `bannedUserName`,
            h.reason          AS `reason`,
            h.start_time      AS `startTime`,
            h.create_time     AS `createTime`
        FROM user_ban_history h
        JOIN user u     ON h.user_id  = u.user_id
        JOIN user admin ON h.admin_id = admin.user_id
        ORDER BY h.create_time DESC
        LIMIT 50
    </select>

</mapper>

