<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改头像</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --bg-body: #f3f4f6; --radius-md: 8px; }
        body { background-color: var(--bg-body); padding: 20px; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; }

        .ibox { background: #fff; border-radius: var(--radius-md); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ibox-title { border-bottom: 1px solid #eee; padding: 15px 20px; font-weight: 600; }
        .ibox-content { padding: 40px; }

        .avatar-preview-area { text-align: center; border-right: 1px solid #eee; }
        .img-preview-lg { width: 180px; height: 180px; border-radius: 50%; border: 4px solid #f3f4f6; object-fit: cover; margin-bottom: 15px; }
        .btn-primary { background-color: var(--primary); border-color: var(--primary); }

        .upload-area { padding-left: 30px; padding-top: 20px; }

        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; margin-bottom: 0; vertical-align: middle; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        .upload-row { display: flex; align-items: center; gap: 15px; }
    </style>
</head>
<body class="gray-bg">
<div class="row">
    <div class="col-sm-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>修改头像</h5>
            </div>
            <div class="ibox-content">

                <div th:if="${msg}" class="alert alert-info" th:text="${msg}"></div>

                <div class="row">
                    <div class="col-md-5 avatar-preview-area">
                        <h4>当前头像 / 预览</h4>

                        <img id="avatar-preview"
                             th:src="${user.avatar != null && user.avatar != ''} ? (${#strings.startsWith(user.avatar, 'http://') || #strings.startsWith(user.avatar, 'https://')} ? ${user.avatar} : @{/upload/{f}(f=${user.avatar})}) : @{/img/default_avatar.png}"
                             class="img-preview-lg"
                             onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff'">

                        <p class="text-muted small">大尺寸预览 180x180</p>
                    </div>

                    <div class="col-md-7 upload-area">
                        <h3>上传新头像</h3>
                        <p>请选择一张本地图片上传，支持 JPG, GIF 或 PNG 格式。</p>

                        <form th:action="@{/user/uploadAvatar}" method="post" enctype="multipart/form-data" class="form-horizontal">
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <div class="upload-row">
                                        <div class="file-input-wrapper">
                                            <button class="btn btn-white btn-lg" type="button">
                                                <i class="fa fa-folder-open"></i> 选择图片...
                                            </button>
                                            <input type="file" name="avatarFile" id="avatar-input" accept="image/*">
                                        </div>
                                        <span id="file-name" class="text-info">未选择文件</span>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning" style="margin-top: 20px;">
                                <i class="fa fa-info-circle"></i> 提示：图片大小不超过 2MB，建议尺寸 200x200 像素。
                            </div>

                            <div class="hr-line-dashed"></div>

                            <button class="btn btn-primary" type="submit">
                                <i class="fa fa-upload"></i> 确认上传并保存
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/bootstrap.min.js}"></script>

<script>
    $(document).ready(function(){
        $("#avatar-input").change(function(){
            var file = this.files[0];
            if (file) {
                $("#file-name").text("已选择: " + file.name);
                $("#file-name").removeClass("text-info").addClass("text-success");

                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#avatar-preview').attr('src', e.target.result);
                }
                reader.readAsDataURL(file);
            } else {
                $("#file-name").text("未选择文件");
                $("#file-name").removeClass("text-success").addClass("text-info");
            }
        });
    });
</script>
</body>
</html>
