<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>小宁论坛 - 用户管理</title>
    <meta name="keywords" content="小宁论坛,后台管理,用户管理">
    <meta name="description" content="小宁论坛后台管理系统 - 用户管理页面">
    <link rel="shortcut icon" href="favicon.ico"> 
    <link href="css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">

    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css?v=4.1.0" rel="stylesheet">

    <style>
        /* 仅针对本页的小范围美化，不影响整体框架 */
        .ibox-content {
            border-radius: 4px;
        }

        .clients-list .nav-tabs {
            border-bottom: 1px solid #e7eaec;
            padding: 0 5px;
        }

        .clients-list .nav-tabs > li > a {
            padding: 8px 15px;
        }

        #statusFilter {
            min-width: 120px;
        }

        #searchInput {
            border-right: none;
        }

        #searchBtn {
            border-radius: 0 4px 4px 0;
        }

        .table thead th {
            background: #f9f9f9;
            border-bottom: 1px solid #e7eaec;
            font-weight: 600;
        }

        .table-hover tbody tr:hover {
            background-color: #f5f5f5;
        }

        .client-avatar img {
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.15);
        }

        /* 分页样式统一为消息管理页面样式 */
        #pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            border-top: none;
        }
        #pagination > li {
            display: inline-block;
            margin: 0 2px;
        }
        #pagination > li > a {
            display: block;
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            color: #6b7280;
            text-decoration: none;
            cursor: pointer;
            background: white;
        }
        #pagination > li.active > a,
        #pagination > li.active > a:focus,
        #pagination > li.active > a:hover {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }
        #pagination > li.disabled > a {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #pagination > li > a:hover {
            background: #f3f4f6;
        }
        #pagination > li.disabled > a:hover {
            background: white;
        }

        /* 右侧详情区排版优化 */
        #contact-1 h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        #contact-1 h3 {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 10px;
        }

        #contact-1 p {
            font-size: 13px;
            color: #676a6c;
        }

        /* 模态框表单更紧凑 */
        #addUserModal .modal-body .form-group,
        #editUsernameModal .modal-body .form-group,
        #editRoleModal .modal-body .form-group {
            margin-bottom: 10px;
        }

        #addUserModal .modal-title,
        #editUsernameModal .modal-title,
        #editRoleModal .modal-title {
            font-size: 16px;
        }

        /* 操作下拉中的分割线 */
        .operation-separator {
            color: #c2c2c2;
        }

        /* 被封禁用户整行标红 */
        .banned-row td {
            color: #d9534f;
            background-color: #fef2f2;
        }
    </style>

</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <!-- 左侧：用户列表 -->
            <div class="col-sm-8">
                <div class="ibox">
                    <div class="ibox-content">
                        <span class="text-muted small pull-right">最后更新：<i class="fa fa-clock-o"></i> 2015-09-01 12:00</span>
                        <h2>用户管理</h2>
                        <p>所有客户必须通过身份验证</p>

                        <!-- 搜索与添加用户 -->
                        <div class="row m-b-sm">
                            <div class="col-sm-8">
                        <div class="input-group">
                                    <input type="text" id="searchInput" placeholder="查找客户（用户名/姓名/邮箱/电话）" class="input form-control">
                            <span class="input-group-btn">
                                        <button type="button" id="searchBtn" class="btn btn-primary">
                                            <i class="fa fa-search"></i> 搜索
                                        </button>
                                </span>
                                </div>
                            </div>
                            <div class="col-sm-4 text-right">
                                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addUserModal">
                                    <i class="fa fa-user-plus"></i> 添加用户
                                </button>
                            </div>
                        </div>

                        <div class="clients-list">
                            <ul class="nav nav-tabs">
                                <li class="active">
                                    <a data-toggle="tab" href="#tab-2">
                                        <i class="fa fa-briefcase"></i> 用户
                                    </a>
                                </li>
                                <li style="margin-top: 8px; margin-left: 10px;">
                                    <select id="statusFilter" class="form-control" style="border-radius: 4px; height: 30px; padding: 0 10px;">
                                        <option value="all">全部用户</option>
                                        <option value="normal">正常用户</option>
                                        <option value="banned">已封禁用户</option>
                                    </select>
                                </li>
                                <span class="pull-right small text-muted" id="userCountText" style="margin-top: 10px;">共 0 个用户</span>
                            </ul>
                            <div class="tab-content">
                                <div id="tab-2" class="tab-pane active">
                                    <!-- 取消滚动条，只用自适应表格 -->
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                            <thead>
                                                    <tr>
                                                    <th>头像</th>
                                                    <th>用户名</th>
                                                    <th>姓名</th>
                                                    <th>性别</th>
                                                    <th>电话号</th>
                                                    <th>邮箱</th>
                                                    <th>密码</th>
                                                    <th>操作</th>
                                                    </tr>
                                            </thead>
                                            <tbody id="userTableBody">
                                                </tbody>
                                            </table>
                                    </div>

                                    <!-- 分页 -->
                                    <div class="row">
                                        <div class="col-sm-12 text-center">
                                            <ul class="pagination pagination-sm" id="pagination" style="margin: 0;">
                                                <!-- 动态生成 -->
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12 text-center">
                                            <span class="small text-muted" id="recordText">共 0 条记录</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：用户详情 -->
            <div class="col-sm-4">
                <div class="ibox">
                    <div class="ibox-content">
                        <div class="tab-content">
                            <div id="contact-1" class="tab-pane active">
                                <div class="row m-b-lg">
                                    <div class="col-lg-4 text-center">
                                        <h2 id="detailUsername">请选择用户</h2>

                                        <div class="m-b-sm">
                                            <img alt="image" id="detailAvatar" class="img-circle" src="img/a2.jpg" style="width: 62px">
                                        </div>
                                    </div>
                                    <div class="col-lg-8">
                                        <h3>用户信息</h3>

                                        <p style="margin-bottom: 5px;"><strong>姓名：</strong><span id="detailRealName">-</span></p>
                                        <p style="margin-bottom: 5px;"><strong>性别：</strong><span id="detailGender">-</span></p>
                                        <p style="margin-bottom: 5px;"><strong>电话：</strong><span id="detailPhone">-</span></p>
                                        <p style="margin-bottom: 5px;"><strong>邮箱：</strong><span id="detailEmail">-</span></p>
                                        <p style="margin-bottom: 5px;"><strong>密码：</strong><span id="detailPassword">-</span></p>
                                        <p style="margin-bottom: 5px;"><strong>地址：</strong><span id="detailAddress">-</span></p>
                                        <p style="margin-bottom: 5px;"><strong>身份：</strong><span id="detailRole">-</span></p>
                                        <p style="margin-bottom: 5px;">
                                            <strong>是否被封禁：</strong>
                                            <span id="detailBanned" class="label label-success">正常</span>
                                        </p>
                                        <p style="margin-bottom: 5px;"><strong>警告次数：</strong><span id="detailWarnings">0</span></p>
                                        <p style="margin-bottom: 5px;"><strong>个性签名：</strong><span id="detailSignature">-</span></p>
                                        <button type="button" class="btn btn-primary btn-sm btn-block m-t-sm" id="sendMessageBtn">
                                            <i class="fa fa-envelope"></i> 发送消息
                                        </button>
                                    </div>
                                </div>
                                <div class="client-detail">
                                    <!-- 保持样式简洁美观，可扩展其他信息 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script src="js/jquery.min.js?v=2.1.4"></script>
    <script src="js/bootstrap.min.js?v=3.3.6"></script>

    <!-- 自定义js -->
    <script src="js/content.js?v=1.0.0"></script>

    <script>
        $(function () {
            // 模拟用户数据
            var users = [
                {
                    id: 1,
                    username: 'xiaoming',
                    realName: '小明',
                    gender: '男',
                    phone: '13800000001',
                    email: 'xiaoming@example.com',
                    password: '123456',
                    address: '浙江省杭州市西湖区',
                    role: '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: '热爱生活，享受每一天。',
                    avatar: 'img/a1.jpg'
                },
                {
                    id: 2,
                    username: 'runner01',
                    realName: '张跑跑',
                    gender: '男',
                    phone: '13800000002',
                    email: 'runner01@example.com',
                    password: 'runner123',
                    address: '浙江省杭州市滨江区',
                    role: '跑腿员',
                    banned: false,
                    warnings: 1,
                    signature: '风里雨里，我在路上。',
                    avatar: 'img/a2.jpg'
                },
                {
                    id: 3,
                    username: 'xiaohong',
                    realName: '小红',
                    gender: '女',
                    phone: '13800000003',
                    email: 'xiaohong@example.com',
                    password: 'hong123',
                    address: '上海市浦东新区',
                    role: '普通用户',
                    banned: true,
                    warnings: 3,
                    signature: '安静的做个小透明。',
                    avatar: 'img/a3.jpg'
                },
                {
                    id: 4,
                    username: 'deliver02',
                    realName: '李快递',
                    gender: '男',
                    phone: '13800000004',
                    email: 'deliver02@example.com',
                    password: 'deliver456',
                    address: '北京市海淀区',
                    role: '跑腿员',
                    banned: false,
                    warnings: 2,
                    signature: '城市的每个角落都有我的脚步。',
                    avatar: 'img/a4.jpg'
                },
                {
                    id: 5,
                    username: 'sunny',
                    realName: '孙阳',
                    gender: '女',
                    phone: '13800000005',
                    email: 'sunny@example.com',
                    password: 'sunny789',
                    address: '南京市鼓楼区',
                    role: '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: '向阳而生，温柔以待。',
                    avatar: 'img/a5.jpg'
                },
                {
                    id: 6,
                    username: 'coffee',
                    realName: '周启',
                    gender: '男',
                    phone: '13800000006',
                    email: 'coffee@example.com',
                    password: 'coffee123',
                    address: '广州市天河区',
                    role: '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: '咖啡与代码不可辜负。',
                    avatar: 'img/a6.jpg'
                },
                {
                    id: 7,
                    username: 'runner02',
                    realName: '王飞',
                    gender: '男',
                    phone: '13800000007',
                    email: 'runner02@example.com',
                    password: 'runner789',
                    address: '成都市锦江区',
                    role: '跑腿员',
                    banned: false,
                    warnings: 1,
                    signature: '只要你需要，我就出现。',
                    avatar: 'img/a7.jpg'
                },
                {
                    id: 8,
                    username: 'alice',
                    realName: '艾丽丝',
                    gender: '女',
                    phone: '13800000008',
                    email: 'alice@example.com',
                    password: 'alice456',
                    address: '深圳市南山区',
                    role: '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: '保持好奇，探索世界。',
                    avatar: 'img/a8.jpg'
                },
                {
                    id: 9,
                    username: 'banned01',
                    realName: '赵封封',
                    gender: '男',
                    phone: '13800000009',
                    email: 'banned01@example.com',
                    password: 'banned123',
                    address: '武汉市洪山区',
                    role: '普通用户',
                    banned: true,
                    warnings: 5,
                    signature: '我会改正的。',
                    avatar: 'img/a9.jpg'
                },
                {
                    id: 10,
                    username: 'runner03',
                    realName: '周跑跑',
                    gender: '男',
                    phone: '13800000010',
                    email: 'runner03@example.com',
                    password: 'runner321',
                    address: '天津市和平区',
                    role: '跑腿员',
                    banned: false,
                    warnings: 0,
                    signature: '守时是我的底线。',
                    avatar: 'img/a10.jpg'
                },
                {
                    id: 11,
                    username: 'lucy',
                    realName: '露西',
                    gender: '女',
                    phone: '13800000011',
                    email: 'lucy@example.com',
                    password: 'lucy123',
                    address: '杭州市拱墅区',
                    role: '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: '读书、旅行和猫。',
                    avatar: 'img/a1.jpg'
                },
                {
                    id: 12,
                    username: 'mark',
                    realName: '马克',
                    gender: '男',
                    phone: '13800000012',
                    email: 'mark@example.com',
                    password: 'mark456',
                    address: '苏州市姑苏区',
                    role: '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: '简单才是真。',
                    avatar: 'img/a2.jpg'
                },
                {
                    id: 13,
                    username: 'nancy',
                    realName: '南希',
                    gender: '女',
                    phone: '13800000013',
                    email: 'nancy@example.com',
                    password: 'nancy789',
                    address: '重庆市渝中区',
                    role: '普通用户',
                    banned: false,
                    warnings: 1,
                    signature: '偶尔发呆，也是一种浪漫。',
                    avatar: 'img/a3.jpg'
                },
                {
                    id: 14,
                    username: 'helper01',
                    realName: '帮帮',
                    gender: '男',
                    phone: '13800000014',
                    email: 'helper01@example.com',
                    password: 'helper123',
                    address: '青岛市市南区',
                    role: '跑腿员',
                    banned: false,
                    warnings: 0,
                    signature: '帮助别人也是成就自己。',
                    avatar: 'img/a4.jpg'
                },
                {
                    id: 15,
                    username: 'silent',
                    realName: '寂静',
                    gender: '男',
                    phone: '13800000015',
                    email: 'silent@example.com',
                    password: 'silent456',
                    address: '厦门市思明区',
                    role: '普通用户',
                    banned: true,
                    warnings: 4,
                    signature: '暂时离线。',
                    avatar: 'img/a5.jpg'
                }
            ];

            var currentPage = 1;
            var pageSize = 10;
            var currentDetailUserId = null;

            var $tbody = $('#userTableBody');
            var $userCountText = $('#userCountText');
            var $recordText = $('#recordText');
            var $pagination = $('#pagination');

            function getFilteredUsers() {
                var status = $('#statusFilter').val();
                var keyword = $.trim($('#searchInput').val()).toLowerCase();
                return users.filter(function (u) {
                    if (status === 'normal' && u.banned) return false;
                    if (status === 'banned' && !u.banned) return false;
                    if (keyword) {
                        var text = (u.username + u.realName + u.email + u.phone).toLowerCase();
                        if (text.indexOf(keyword) === -1) return false;
                    }
                    return true;
                });
            }

            function renderTable() {
                var list = getFilteredUsers();
                var total = list.length;
                var totalPage = Math.max(1, Math.ceil(total / pageSize));
                if (currentPage > totalPage) {
                    currentPage = totalPage;
                }
                var start = (currentPage - 1) * pageSize;
                var end = start + pageSize;
                var pageList = list.slice(start, end);

                $tbody.empty();
                pageList.forEach(function (u) {
                    var operationOptions = [
                        '<option value="">请选择操作</option>',
                        '<option value="view">查看信息</option>',
                        '<option value="" disabled class="operation-separator">──────────</option>',
                        '<option value="reset">重置密码</option>',
                        '<option value="editName">修改用户名</option>',
                        '<option value="editRole">修改身份</option>',
                        '<option value="" disabled class="operation-separator">──────────</option>'
                    ];
                    if (u.banned) {
                        operationOptions.push('<option value="unban">恢复用户</option>');
                    } else {
                        operationOptions.push('<option value="ban">封禁用户</option>');
                    }
                    operationOptions.push('<option value="delete">删除用户</option>');

                    var trClass = u.banned ? ' class="banned-row"' : '';
                    var tr = $(
                        '<tr data-id="' + u.id + '"' + trClass + '>' +
                        '<td class="client-avatar"><img alt="image" src="' + u.avatar + '" style="width:32px;height:32px;border-radius:50%;"></td>' +
                        '<td><a href="javascript:void(0);" class="client-link">' + u.username + '</a></td>' +
                        '<td>' + u.realName + '</td>' +
                        '<td>' + u.gender + '</td>' +
                        '<td>' + u.phone + '</td>' +
                        '<td>' + u.email + '</td>' +
                        '<td>' + (u.password || '-') + '</td>' +
                        '<td>' +
                        '<select class="form-control input-sm user-operation">' +
                        operationOptions.join('') +
                        '</select>' +
                        '</td>' +
                        '</tr>'
                    );
                    $tbody.append(tr);
                });

                $userCountText.text('共 ' + users.length + ' 个用户');
                $recordText.text('共 ' + total + ' 条记录');

                renderPagination(totalPage);

                // 默认选中当前页第一条显示详细信息
                if (pageList.length > 0) {
                    updateDetail(pageList[0].id);
                } else {
                    clearDetail();
                }
            }

            function renderPagination(totalPage) {
                $pagination.empty();
                
                if (totalPage === 0) {
                    return;
                }
                
                // 上一页
                var prevClass = currentPage === 1 ? 'disabled' : '';
                var $prev = $('<li class="' + prevClass + '"><a href="#" data-page="' + (currentPage - 1) + '">上一页</a></li>');
                $pagination.append($prev);
                
                // 页码
                for (var i = 1; i <= totalPage; i++) {
                    if (i === 1 || i === totalPage || (i >= currentPage - 2 && i <= currentPage + 2)) {
                        var active = currentPage === i ? 'active' : '';
                        var $li = $('<li class="' + active + '"><a href="#" data-page="' + i + '">' + i + '</a></li>');
                        $pagination.append($li);
                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                        var $li = $('<li class="disabled"><a href="#">...</a></li>');
                        $pagination.append($li);
                    }
                }
                
                // 下一页
                var nextClass = currentPage === totalPage ? 'disabled' : '';
                var $next = $('<li class="' + nextClass + '"><a href="#" data-page="' + (currentPage + 1) + '">下一页</a></li>');
                $pagination.append($next);
            }

            function findUserById(id) {
                for (var i = 0; i < users.length; i++) {
                    if (users[i].id === id) return users[i];
                }
                return null;
            }

            function updateDetail(id) {
                var user = findUserById(id);
                if (!user) {
                    clearDetail();
                    return;
                }
                currentDetailUserId = user.id;
                $('#detailUsername').text(user.username);
                $('#detailRealName').text(user.realName);
                $('#detailGender').text(user.gender);
                $('#detailPhone').text(user.phone);
                $('#detailEmail').text(user.email);
                $('#detailPassword').text(user.password || '-');
                $('#detailAddress').text(user.address);
                $('#detailRole').text(user.role);
                $('#detailSignature').text(user.signature || '-');
                $('#detailWarnings').text(user.warnings || 0);
                $('#detailAvatar').attr('src', user.avatar || 'img/a2.jpg');

                var $banned = $('#detailBanned');
                if (user.banned) {
                    $banned.removeClass('label-success').addClass('label-danger').text('已封禁');
                } else {
                    $banned.removeClass('label-danger').addClass('label-success').text('正常');
                }
            }

            function clearDetail() {
                currentDetailUserId = null;
                $('#detailUsername').text('请选择用户');
                $('#detailRealName').text('-');
                $('#detailGender').text('-');
                $('#detailPhone').text('-');
                $('#detailEmail').text('-');
                $('#detailPassword').text('-');
                $('#detailAddress').text('-');
                $('#detailRole').text('-');
                $('#detailSignature').text('-');
                $('#detailWarnings').text('0');
                $('#detailAvatar').attr('src', 'img/a2.jpg');
                $('#detailBanned').removeClass('label-danger').addClass('label-success').text('正常');
            }

            // 分页点击
            $(document).on('click', '#pagination a', function(e) {
                e.preventDefault();
                if ($(this).parent().hasClass('disabled') || $(this).parent().hasClass('active')) {
                    return;
                }
                
                var page = $(this).data('page');
                if (page) {
                    var totalPage = Math.max(1, Math.ceil(getFilteredUsers().length / pageSize));
                    if (page >= 1 && page <= totalPage) {
                        currentPage = page;
                        renderTable();
                    }
                }
            });

            // 过滤与搜索
            $('#statusFilter').on('change', function () {
                currentPage = 1;
                renderTable();
            });

            $('#searchBtn').on('click', function () {
                currentPage = 1;
                renderTable();
            });

            $('#searchInput').on('keyup', function (e) {
                if (e.keyCode === 13) {
                    currentPage = 1;
                    renderTable();
                }
            });

            // 点击用户名查看详情
            $tbody.on('click', '.client-link', function () {
                var id = parseInt($(this).closest('tr').data('id'), 10);
                updateDetail(id);
            });

            // 操作下拉
            var currentOperateUserId = null;

            $tbody.on('change', '.user-operation', function () {
                var $select = $(this);
                var action = $select.val();
                var id = parseInt($select.closest('tr').data('id'), 10);
                if (!action) return;

                currentOperateUserId = id;

                if (action === 'view') {
                    updateDetail(id);
                } else if (action === 'reset') {
                    alert('已为该用户重置密码（模拟操作）。');
                } else if (action === 'editName') {
                    var user = findUserById(id);
                    if (!user) return;
                    $('#editUsernameOld').val(user.username);
                    $('#editUsernameNew').val(user.username);
                    $('#editUsernameModal').modal('show');
                } else if (action === 'editRole') {
                    var u = findUserById(id);
                    if (!u) return;
                    $('#editRoleSelect').val(u.role === '跑腿员' ? 'runner' : 'normal');
                    $('#editRoleModal').modal('show');
                } else if (action === 'ban') {
                    $('#banModalText').text('确定要封禁该用户吗？');
                    $('#banConfirmBtn').data('type', 'ban');
                    $('#banConfirmModal').modal('show');
                } else if (action === 'unban') {
                    $('#banModalText').text('确定要恢复该用户吗？');
                    $('#banConfirmBtn').data('type', 'unban');
                    $('#banConfirmModal').modal('show');
                } else if (action === 'delete') {
                    $('#banModalText').text('确定要删除该用户吗？删除后不可恢复。');
                    $('#banConfirmBtn').data('type', 'delete');
                    $('#banConfirmModal').modal('show');
                }

                // 操作后重置下拉选项
                setTimeout(function () {
                    $select.val('');
                }, 0);
            });

            // 修改用户名保存
            $('#saveUsernameBtn').on('click', function () {
                var user = findUserById(currentOperateUserId);
                if (!user) return;
                var newName = $.trim($('#editUsernameNew').val());
                if (!newName) {
                    alert('用户名不能为空');
                    return;
                }
                user.username = newName;
                $('#editUsernameModal').modal('hide');
                renderTable();
                updateDetail(user.id);
            });

            // 修改身份保存
            $('#saveRoleBtn').on('click', function () {
                var user = findUserById(currentOperateUserId);
                if (!user) return;
                var roleValue = $('#editRoleSelect').val();
                user.role = roleValue === 'runner' ? '跑腿员' : '普通用户';
                $('#editRoleModal').modal('hide');
                renderTable();
                updateDetail(user.id);
            });

            // 封禁/恢复确认
            $('#banConfirmBtn').on('click', function () {
                var type = $(this).data('type');
                var user = findUserById(currentOperateUserId);
                if (!user && type !== 'delete') return;
                if (type === 'ban') {
                    user.banned = true;
                } else if (type === 'unban') {
                    user.banned = false;
                } else if (type === 'delete') {
                    for (var i = 0; i < users.length; i++) {
                        if (users[i].id === currentOperateUserId) {
                            users.splice(i, 1);
                            break;
                        }
                    }
                    if (currentDetailUserId === currentOperateUserId) {
                        clearDetail();
                    }
                    $('#banConfirmModal').modal('hide');
                    renderTable();
                    return;
                }
                $('#banConfirmModal').modal('hide');
                renderTable();
                updateDetail(user.id);
            });

            // 添加用户头像预览
            $('#addAvatar').on('change', function (e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function (evt) {
                    $('#addAvatarPreview').attr('src', evt.target.result);
                };
                reader.readAsDataURL(file);
            });

            // 添加用户保存
            $('#saveAddUserBtn').on('click', function () {
                var username = $.trim($('#addUsername').val());
                var realName = $.trim($('#addRealName').val());
                var gender = $('#addGender').val();
                var phone = $.trim($('#addPhone').val());
                var email = $.trim($('#addEmail').val());
                var password = $.trim($('#addPassword').val());
                var address = $.trim($('#addAddress').val());
                var roleVal = $('#addRole').val();
                var signature = $.trim($('#addSignature').val());
                var avatarSrc = $('#addAvatarPreview').attr('src') || 'img/a2.jpg';

                if (!username || !realName) {
                    alert('用户名和姓名不能为空');
                    return;
                }

                var newId = users.length ? (users[users.length - 1].id + 1) : 1;
                users.push({
                    id: newId,
                    username: username,
                    realName: realName,
                    gender: gender,
                    phone: phone || '未填写',
                    email: email || '未填写',
                    password: password || '',
                    address: address || '未填写',
                    role: roleVal === 'runner' ? '跑腿员' : '普通用户',
                    banned: false,
                    warnings: 0,
                    signature: signature || '-',
                    avatar: avatarSrc
                });

                $('#addUserModal').modal('hide');
                $('#addUserForm')[0].reset();
                $('#addAvatarPreview').attr('src', 'img/a2.jpg');

                currentPage = Math.ceil(getFilteredUsers().length / pageSize);
                renderTable();
            });

            // 初始化
            renderTable();

            // 发送消息按钮：跳转到消息管理-私信（示例：mailbox.html，可按实际路径调整）
            $('#sendMessageBtn').on('click', function () {
                if (!currentDetailUserId) {
                    alert('请先选择一个用户');
                    return;
                }
                // 简单跳转，保证不报错
                window.location.href = 'msg_send.html';
            });
        });
    </script>

    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=9051096" charset="UTF-8"></script>
    <!--统计代码，可删除-->

    <!-- 模态框：修改用户名 -->
    <div class="modal fade" id="editUsernameModal" tabindex="-1" role="dialog" aria-labelledby="editUsernameModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="editUsernameModalLabel">修改用户名</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>原用户名</label>
                        <input type="text" id="editUsernameOld" class="form-control" disabled>
                    </div>
                    <div class="form-group">
                        <label>新用户名</label>
                        <input type="text" id="editUsernameNew" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveUsernameBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：修改身份 -->
    <div class="modal fade" id="editRoleModal" tabindex="-1" role="dialog" aria-labelledby="editRoleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="editRoleModalLabel">修改身份</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>身份</label>
                        <select id="editRoleSelect" class="form-control">
                            <option value="normal">普通用户</option>
                            <option value="runner">跑腿员</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveRoleBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：封禁/恢复确认 -->
    <div class="modal fade" id="banConfirmModal" tabindex="-1" role="dialog" aria-labelledby="banConfirmModalLabel">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="banConfirmModalLabel">提示</h4>
                </div>
                <div class="modal-body">
                    <p id="banModalText">确定要封禁该用户吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="banConfirmBtn">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：添加用户 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="addUserForm" onsubmit="return false;">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="addUserModalLabel">添加用户</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-4 text-center">
                                <img id="addAvatarPreview" src="img/a2.jpg" class="img-circle m-b-sm" style="width: 80px; height: 80px;">
                                <div class="form-group m-t-sm">
                                    <label class="btn btn-default btn-sm">
                                        上传头像 <input type="file" id="addAvatar" style="display: none;" accept="image/*">
                                    </label>
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <div class="form-group">
                                    <label>用户名</label>
                                    <input type="text" id="addUsername" class="form-control" placeholder="请输入用户名">
                                </div>
                                <div class="form-group">
                                    <label>姓名</label>
                                    <input type="text" id="addRealName" class="form-control" placeholder="请输入姓名">
                                </div>
                                <div class="form-group">
                                    <label>性别</label>
                                    <select id="addGender" class="form-control">
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>电话号</label>
                                    <input type="text" id="addPhone" class="form-control" placeholder="请输入电话号">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>邮箱</label>
                                    <input type="email" id="addEmail" class="form-control" placeholder="请输入邮箱">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>密码</label>
                                    <input type="text" id="addPassword" class="form-control" placeholder="请输入密码（明文）">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>身份</label>
                                    <select id="addRole" class="form-control">
                                        <option value="normal">普通用户</option>
                                        <option value="runner">跑腿员</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>地址</label>
                                    <input type="text" id="addAddress" class="form-control" placeholder="请输入地址">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>个性签名</label>
                            <textarea id="addSignature" class="form-control" rows="2" placeholder="写一句话介绍自己"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="saveAddUserBtn">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</body>

</html>
