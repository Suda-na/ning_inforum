<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小宁论坛 - 权限管理</title>
    <meta name="keywords" content="小宁论坛,后台管理,权限管理">
    <meta name="description" content="小宁论坛后台管理系统 - 权限管理页面">
    <link rel="shortcut icon" th:href="@{/favicon.ico}"> 
    <link th:href="@{/css/bootstrap.min.css?v=3.3.6}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.css?v=4.4.0}" rel="stylesheet">

    <link th:href="@{/css/animate.css}" rel="stylesheet">
    <link th:href="@{/css/style.css?v=4.1.0}" rel="stylesheet">
    <style>
        /* 分页样式统一为消息管理页面样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            border-top: none;
        }
        .pagination li {
            display: inline-block;
            margin: 0 2px;
        }
        .pagination li a {
            display: block;
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            color: #6b7280;
            text-decoration: none;
            cursor: pointer;
            background: white;
        }
        .pagination li.active a {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .pagination li.disabled a {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .pagination li a:hover {
            background: #f3f4f6;
        }
        .pagination li.disabled a:hover {
            background: white;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content  animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox">
                    <div class="ibox-content">
                        <span class="text-muted small pull-right">最后更新：<i class="fa fa-clock-o"></i> 2025-12-14 12:00</span>
                        <h2>权限管理</h2>
                        <p>
                            管理用户评论权限
                        </p>
                        <div class="input-group">
                            <input type="text" id="searchInput" placeholder="查找用户" class="input form-control">
                            <span class="input-group-btn">
                                <button type="button" id="searchBtn" class="btn btn btn-primary"> <i class="fa fa-search"></i> 搜索</button>
                                <button type="button" id="resetBtn" class="btn btn btn-default"> <i class="fa fa-refresh"></i> 重置</button>
                            </span>
                        </div>
                        <div class="clients-list m-t-md">
                            <ul class="nav nav-tabs">
                                <span class="pull-right small text-muted" th:text="|${#lists.size(users)} 个用户|"></span>
                                <li class="active"><a data-toggle="tab" href="#tab-1"><i class="fa fa-users"></i> 用户权限</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div id="tab-1" class="tab-pane active">
                                    <div class="full-height-scroll" style="position: relative;">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>头像</th>
                                                        <th>用户信息</th>
                                                        <th>动态权限</th>
                                                        <th>评论权限</th>
                                                        <th>私信权限</th>
                                                        <th>封禁权限</th>
                                                        <th>封禁时间</th>
                                                        <th>恢复权限</th>
                                                        <th>操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="permissionsTableBody">
                                                    <tr th:each="user : ${users}" th:attr="data-user-id=${user.userId}">
                                                        <td class="client-avatar"><img alt="image" th:src="@{/img/{avatar}(avatar=${user.avatar})}"> </td>
                                                        <td>
                                                            <a href="#" class="client-link" th:text="${user.username}"></a>
                                                            <br>
                                                            <small class="text-muted" th:text="|真实姓名: ${user.realName}|"></small>
                                                        </td>
                                                        <td>
                                                            <span th:class="|label ${user.permission.canPost == 1 ? 'label-success' : (user.isPermanentBans?.post == true ? 'label-danger' : 'label-warning')} dynamic-status|" 
                                                                  th:text="${user.permission.canPost == 1 ? '允许发布' : user.activeBans?.post ?: '禁止发布'}"></span>
                                                        </td>
                                                        <td>
                                                            <span th:class="|label ${user.permission.canComment == 1 ? 'label-success' : (user.isPermanentBans?.comment == true ? 'label-danger' : 'label-warning')} comment-status|" 
                                                                  th:text="${user.permission.canComment == 1 ? '允许评论' : user.activeBans?.comment ?: '禁止评论'}"></span>
                                                        </td>
                                                        <td>
                                                            <span th:class="|label ${user.permission.canMessage == 1 ? 'label-success' : (user.isPermanentBans?.message == true ? 'label-danger' : 'label-warning')} message-status|" 
                                                                  th:text="${user.permission.canMessage == 1 ? '允许私信' : user.activeBans?.message ?: '禁止私信'}"></span>
                                                        </td>
                                                        <td>
                                                            <select class="form-control ban-permission" style="border-radius: 4px;">
                                                                <option value="">选择要封禁的权限</option>
                                                                <option value="dynamic">动态权限</option>
                                                                <option value="comment">评论权限</option>
                                                                <option value="message">私信权限</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control ban-time" style="border-radius: 4px;">
                                                                <option value="">选择要封禁的时间</option>
                                                                <option value="ban1">封禁一天</option>
                                                                <option value="ban3">封禁三天</option>
                                                                <option value="banForever">永久封禁</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-control restore-permission" style="border-radius: 4px;">
                                                                <option value="">选择要恢复的权限</option>
                                                                <option value="dynamic">动态权限</option>
                                                                <option value="comment">评论权限</option>
                                                                <option value="message">私信权限</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-primary btn-xs execute-operation">执行操作</button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div id="paginationContainer" class="text-center m-t-md"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script th:src="@{/js/jquery.min.js?v=2.1.4}"></script>
    <script th:src="@{/js/bootstrap.min.js?v=3.3.6}"></script>

    <script th:src="@{/js/plugins/slimscroll/jquery.slimscroll.min.js}"></script>

    <!-- 自定义js -->
    <script th:src="@{/js/content.js?v=1.0.0}"></script>

    <script>
        $(function () {
            $('.full-height-scroll').slimScroll({
                height: '100%'
            });
        });
    </script>

    <script>
        // 保存原始选项，用于恢复
        let originalPermissionOptions = [];
        
        // 分页相关变量
        let allUsers = [];
        let originalUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;
        
        // 渲染用户列表
        function renderUsers() {
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = allUsers.slice(startIndex, endIndex);
            
            // 清空表格
            $('#permissionsTableBody').empty();
            
            // 添加当前页的用户
            pageUsers.forEach(function(userRow) {
                $('#permissionsTableBody').append(userRow);
            });
        }
        
        // 渲染分页
        function renderPagination() {
            const totalPages = Math.ceil(allUsers.length / usersPerPage);
            const $pagination = $('#paginationContainer');
            $pagination.empty();
            
            if (totalPages === 0) {
                return;
            }
            
            let paginationHtml = '<ul class="pagination">';
            
            // 上一页
            paginationHtml += `<li ${currentPage === 1 ? 'class="disabled"' : ''}><a href="#" data-page="${currentPage - 1}">上一页</a></li>`;
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHtml += `<li ${i === currentPage ? 'class="active"' : ''}><a href="#" data-page="${i}">${i}</a></li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHtml += `<li class="disabled"><a href="#">...</a></li>`;
                }
            }
            
            // 下一页
            paginationHtml += `<li ${currentPage === totalPages ? 'class="disabled"' : ''}><a href="#" data-page="${currentPage + 1}">下一页</a></li>`;
            
            paginationHtml += '</ul>';
            
            // 更新分页容器
            $pagination.html(paginationHtml);
        }
        
        // 搜索用户
        function searchUsers() {
            const keyword = $('#searchInput').val().trim().toLowerCase();
            if (!keyword) {
                // 如果搜索关键词为空，显示所有用户
                allUsers = originalUsers.slice();
            } else {
                // 根据用户名和真实姓名进行模糊搜索
                allUsers = originalUsers.filter(function(userRow) {
                    const username = userRow.find('.client-link').text().toLowerCase();
                    const realName = userRow.find('.text-muted').text().replace('真实姓名: ', '').toLowerCase();
                    return username.includes(keyword) || realName.includes(keyword);
                });
            }
            // 重置当前页为第一页
            currentPage = 1;
            // 重新渲染用户列表和分页
            renderUsers();
            renderPagination();
        }
        
        // 重置搜索
        function resetSearch() {
            // 清空搜索框
            $('#searchInput').val('');
            // 恢复所有用户
            allUsers = originalUsers.slice();
            // 重置当前页为第一页
            currentPage = 1;
            // 重新渲染用户列表和分页
            renderUsers();
            renderPagination();
        }
        
        // 初始化：保存原始选项和用户数据
        $(document).ready(function() {
            // 保存所有用户数据
            originalUsers = $('#permissionsTableBody tr').map(function() {
                return $(this).clone();
            }).get();
            
            // 初始化显示所有用户
            allUsers = originalUsers.slice();
            
            // 初始化分页
            renderPagination();
            renderUsers();
            
            // 执行操作事件
            $(document).on('click', '.execute-operation', function() {
                let $row = $(this).closest('tr');
                let userId = $row.data('user-id');
                
                // 获取三个下拉选的值
                let banPermission = $row.find('.ban-permission').val();
                let banTime = $row.find('.ban-time').val();
                let restorePermission = $row.find('.restore-permission').val();
                
                // 检查是否有操作被选择
                if (!banPermission && !restorePermission) {
                    alert('请选择要执行的操作');
                    return;
                }
                
                // 处理封禁操作
                if (banPermission && banTime) {
                    let permissionValue = 0; // 0表示禁止
                    let durationDays = 0;
                    let reason = '违规操作'; // 可以根据需要修改
                    let url;
                    let data = {
                        userId: userId,
                        reason: reason
                    };
                    
                    // 确定状态元素和封禁天数
                    let $status;
                    let statusText;
                    let statusClass;
                    
                    if (banPermission === 'dynamic') {
                        $status = $row.find('.dynamic-status');
                        url = '/admin/permissions/updatePostPermission';
                        data.canPost = permissionValue;
                    } else if (banPermission === 'comment') {
                        $status = $row.find('.comment-status');
                        url = '/admin/permissions/updateCommentPermission';
                        data.canComment = permissionValue;
                    } else if (banPermission === 'message') {
                        $status = $row.find('.message-status');
                        url = '/admin/permissions/updateMessagePermission';
                        data.canMessage = permissionValue;
                    } else {
                        alert('无效的权限类型');
                        return;
                    }
                    
                    // 确定封禁天数
                    if (banTime === 'ban1') {
                        durationDays = 1;
                        statusText = '封禁一天';
                        statusClass = 'label-warning';
                    } else if (banTime === 'ban3') {
                        durationDays = 3;
                        statusText = '封禁三天';
                        statusClass = 'label-warning';
                    } else if (banTime === 'banForever') {
                        durationDays = 0; // 0表示永久
                        statusText = '永久封禁';
                        statusClass = 'label-danger';
                    } else {
                        alert('无效的封禁时间');
                        return;
                    }
                    
                    data.durationDays = durationDays;
                    
                    // 发送AJAX请求更新权限
                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: data,
                        success: function(result) {
                            if (result.success) {
                                // 更新状态显示，根据是否为永久封禁设置不同的颜色
                                $status.removeClass('label-success label-danger label-warning label-info');
                                $status.addClass(statusClass).text(statusText);
                                // 重置封禁相关下拉选
                                $row.find('.ban-permission').val('');
                                $row.find('.ban-time').val('');
                                alert('权限更新成功');
                            } else {
                                alert('权限更新失败：' + result.message);
                            }
                        },
                        error: function() {
                            alert('权限更新失败：网络错误');
                        }
                    });
                }
                
                // 处理恢复操作
                if (restorePermission) {
                    let permissionValue = 1; // 1表示允许
                    let durationDays = 0;
                    let reason = '恢复权限';
                    let url;
                    let data = {
                        userId: userId,
                        reason: reason,
                        durationDays: durationDays
                    };
                    
                    // 确定状态元素
                    let $status;
                    let statusText = '允许发布';
                    let statusClass = 'label-success';
                    
                    if (restorePermission === 'dynamic') {
                        $status = $row.find('.dynamic-status');
                        url = '/admin/permissions/updatePostPermission';
                        data.canPost = permissionValue;
                        statusText = '允许发布';
                    } else if (restorePermission === 'comment') {
                        $status = $row.find('.comment-status');
                        url = '/admin/permissions/updateCommentPermission';
                        data.canComment = permissionValue;
                        statusText = '允许评论';
                    } else if (restorePermission === 'message') {
                        $status = $row.find('.message-status');
                        url = '/admin/permissions/updateMessagePermission';
                        data.canMessage = permissionValue;
                        statusText = '允许私信';
                    } else {
                        alert('无效的权限类型');
                        return;
                    }
                    
                    // 发送AJAX请求更新权限
                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: data,
                        success: function(result) {
                            if (result.success) {
                                // 更新状态显示，恢复为绿色成功色
                                $status.removeClass('label-success label-danger label-warning label-info');
                                $status.addClass('label-success').text(statusText);
                                // 重置恢复权限下拉选
                                $row.find('.restore-permission').val('');
                                alert('权限恢复成功');
                            } else {
                                alert('权限恢复失败：' + result.message);
                            }
                        },
                        error: function() {
                            alert('权限恢复失败：网络错误');
                        }
                    });
                }
            });
            
            // 搜索按钮点击事件
            $('#searchBtn').on('click', function() {
                searchUsers();
            });
            
            // 重置按钮点击事件
            $('#resetBtn').on('click', function() {
                resetSearch();
            });
            
            // 搜索框回车键事件
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    searchUsers();
                }
            });
        });
        
        // 分页点击事件
        $(document).on('click', '#paginationContainer .pagination a', function(e) {
            e.preventDefault();
            if ($(this).parent().hasClass('disabled') || $(this).parent().hasClass('active')) {
                return;
            }
            
            const page = parseInt($(this).data('page'), 10);
            if (page) {
                const totalPages = Math.ceil(allUsers.length / usersPerPage);
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderUsers();
                    renderPagination();
                }
            }
        });
    </script>

    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=9051096" charset="UTF-8"></script>
    

</body>

</html>