<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小宁论坛 - 综合运营指挥中心</title>
    
    <link th:href="@{/css/bootstrap.min.css(v=3.3.6)}" rel="stylesheet">
    <link th:href="@{/css/font-awesome.css(v=4.4.0)}" rel="stylesheet">
    <link th:href="@{/css/animate.css}" rel="stylesheet">
    <link th:href="@{/css/style.css(v=4.1.0)}" rel="stylesheet">

    <style>
        /* ================= V4.0 旗舰版样式系统 ================= */
        :root {
            --primary: #4f46e5;       /* 核心蓝 */
            --primary-soft: #e0e7ff;
            --success: #10b981;       /* 成功绿 */
            --success-soft: #d1fae5;
            --warning: #f59e0b;       /* 警告黄 */
            --warning-soft: #fef3c7;
            --danger: #ef4444;        /* 危险红 */
            --danger-soft: #fee2e2;
            --dark: #111827;
            --gray: #6b7280;
            --bg: #f3f4f6;
            --card-radius: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body.gray-bg { background-color: var(--bg); font-family: 'Inter', "Helvetica Neue", Helvetica, Arial, sans-serif; color: #374151; }
        
        /* 1. 顶部状态栏 */
        .dashboard-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding: 5px 10px;
        }
        .header-title h2 { margin: 0; font-weight: 800; color: var(--dark); font-size: 26px; letter-spacing: -0.5px; }
        .header-title small { color: var(--gray); font-size: 13px; font-weight: 500; }
        
        /* 2. 核心指标卡片 (融合了三个页面的关键数字) */
        .metric-card {
            background: #fff; border-radius: var(--card-radius); padding: 24px;
            position: relative; overflow: hidden; box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 24px;
        }
        .metric-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        
        .metric-icon {
            width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; margin-bottom: 15px;
        }
        .metric-value { font-size: 32px; font-weight: 800; color: var(--dark); line-height: 1.1; margin-bottom: 5px; }
        .metric-label { font-size: 14px; color: var(--gray); font-weight: 500; }
        .metric-trend {
            position: absolute; top: 24px; right: 24px; font-size: 13px; font-weight: 600;
            padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;
        }
        
        /* 颜色变体 */
        .card-blue .metric-icon { background: var(--primary-soft); color: var(--primary); }
        .card-blue .metric-trend { background: var(--primary-soft); color: var(--primary); }
        
        .card-green .metric-icon { background: var(--success-soft); color: var(--success); }
        .card-green .metric-trend { background: var(--success-soft); color: var(--success); }
        
        .card-orange .metric-icon { background: var(--warning-soft); color: var(--warning); }
        .card-orange .metric-trend { background: var(--warning-soft); color: var(--warning); }
        
        .card-red .metric-icon { background: var(--danger-soft); color: var(--danger); }
        .card-red .metric-trend { background: var(--danger-soft); color: var(--danger); }

        /* 3. 图表容器 */
        .chart-box {
            background: #fff; border-radius: var(--card-radius); padding: 20px;
            box-shadow: var(--shadow-sm); margin-bottom: 24px; height: 100%;
        }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-title { font-size: 16px; font-weight: 700; color: var(--dark); }

        /* 4. 强大的表格与分页区 */
        .table-container { background: #fff; border-radius: var(--card-radius); box-shadow: var(--shadow-sm); padding: 5px; }
        
        /* 自定义 Tab 样式 */
        .nav-tabs-custom { border-bottom: 1px solid #f3f4f6; padding: 0 10px; }
        .nav-tabs-custom > li > a { 
            border: none; color: var(--gray); font-weight: 600; padding: 20px 20px; 
            font-size: 14px; transition: color 0.2s;
        }
        .nav-tabs-custom > li.active > a { 
            color: var(--primary); border-bottom: 2px solid var(--primary); background: transparent; 
        }
        .nav-tabs-custom > li > a:hover { color: var(--primary); background: transparent; }

        .table-wrapper { padding: 20px; }
        .table > thead > tr > th { 
            background: #f9fafb; border-bottom: none; color: var(--gray); font-weight: 600; 
            text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; padding: 12px 15px;
            &:first-child { border-top-left-radius: 8px; }
            &:last-child { border-top-right-radius: 8px; }
        }
        .table > tbody > tr > td { 
            padding: 16px 15px; border-top: 1px solid #f3f4f6; vertical-align: middle; color: #4b5563; font-size: 13px;
        }
        .table-hover > tbody > tr:hover { background-color: #f8fafc; }

        /* 状态徽章 */
        .badge-status { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-done { background: var(--success-soft); color: var(--success); }
        .badge-wait { background: var(--warning-soft); color: var(--warning); }
        .badge-ban { background: var(--danger-soft); color: var(--danger); }
        .badge-info { background: var(--primary-soft); color: var(--primary); }

        /* 分页控件 */
        .pagination-box { display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid #f3f4f6; }
        .page-info { color: var(--gray); font-size: 13px; }
        .page-btns button {
            border: 1px solid #e5e7eb; background: #fff; padding: 6px 12px; border-radius: 6px; 
            color: #374151; margin-left: 5px; transition: all 0.2s; font-size: 12px;
        }
        .page-btns button:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
        .page-btns button.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .page-btns button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 头像 */
        .avatar-sm { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px; vertical-align: middle; }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        
        <div class="dashboard-header">
            <div class="header-title">
                <h2>综合运营指挥中心</h2>
                <small><i class="fa fa-map-marker"></i> 系统运行正常 | 数据同步于: <span id="updateTime">--:--</span></small>
            </div>
            <div>
                <button class="btn btn-white" onclick="location.reload()"><i class="fa fa-refresh"></i></button>
                <button class="btn btn-primary"><i class="fa fa-cloud-download"></i> 导出周报</button>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3 col-md-6">
                <div class="metric-card card-blue">
                    <div class="metric-trend"><i class="fa fa-arrow-up"></i> 12%</div>
                    <div class="metric-icon"><i class="fa fa-users"></i></div>
                    <div class="metric-value" id="userCountValue">加载中...</div>
                    <div class="metric-label">总用户数 (Total Users)</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card card-green">
                    <div class="metric-trend"><i class="fa fa-bolt"></i> +856</div>
                    <div class="metric-icon"><i class="fa fa-file-text-o"></i></div>
                    <div class="metric-value" id="todayPostCountValue">加载中...</div>
                    <div class="metric-label">今日内容发布 (Content)</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card card-orange">
                    <div class="metric-trend"><i class="fa fa-exclamation-triangle"></i> 需关注</div>
                    <div class="metric-icon"><i class="fa fa-flag"></i></div>
                    <div class="metric-value" id="pendingReportCountValue">加载中...</div>
                    <div class="metric-label">待处理举报 (Pending)</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="metric-card card-red">
                    <div class="metric-trend"><i class="fa fa-plus"></i> 5人</div>
                    <div class="metric-icon"><i class="fa fa-ban"></i></div>
                    <div class="metric-value" id="bannedUserCountValue">加载中...</div>
                    <div class="metric-label">累计封禁账号 (Banned)</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="chart-box">
                    <div class="chart-header">
                        <span class="chart-title"><i class="fa fa-line-chart text-primary"></i> 流量与活跃度趋势</span>
                        <div class="btn-group">
                            <button class="btn btn-xs btn-white active">最近7天</button>
                        </div>
                    </div>
                    <div id="mainTrendChart" style="height: 320px;"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="chart-box">
                    <div class="chart-header">
                        <span class="chart-title"><i class="fa fa-shield text-danger"></i> 社区风险雷达</span>
                    </div>
                    <div id="riskChart" style="height: 320px;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4">
                <div class="chart-box" style="height: 300px;">
                    <div class="chart-header"><span class="chart-title">内容板块热度</span></div>
                    <div id="categoryChart" style="height: 220px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-box" style="height: 300px;">
                    <div class="chart-header"><span class="chart-title">用户性别构成</span></div>
                    <div id="userPieChart" style="height: 220px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-box" style="height: 300px;">
                    <div class="chart-header"><span class="chart-title">举报处理结果</span></div>
                    <div id="resultBarChart" style="height: 220px;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="table-container">
                    
                    <ul class="nav nav-tabs nav-tabs-custom">
                        <li class="active"><a data-toggle="tab" href="#tab-report"><i class="fa fa-gavel"></i> 举报处理 (Reports)</a></li>
                        <li><a data-toggle="tab" href="#tab-user"><i class="fa fa-user-plus"></i> 最新用户 (New Users)</a></li>
                        <li><a data-toggle="tab" href="#tab-content"><i class="fa fa-list-alt"></i> 违规内容日志 (Logs)</a></li>
                    </ul>

                    <div class="tab-content table-wrapper">
                        
                        <div id="tab-report" class="tab-pane active">
                            <div class="row m-b-sm">
                                <div class="col-sm-3">
                                    <div class="input-group">
                                        <input type="text" placeholder="搜索举报ID/内容..." class="form-control input-sm">
                                        <span class="input-group-btn"><button class="btn btn-sm btn-primary">搜索</button></span>
                                    </div>
                                </div>
                            </div>
                            <table class="table table-hover">
                                <thead>
                                    <tr><th>ID</th><th>状态</th><th>类型</th><th>被举报内容</th><th>时间</th><th>结果</th><th>操作</th></tr>
                                </thead>
                                <tbody id="tableBody_report"></tbody>
                            </table>
                            <div class="pagination-box" id="pagination_report"></div>
                        </div>

                        <div id="tab-user" class="tab-pane">
                            <table class="table table-hover">
                                <thead>
                                    <tr><th>用户ID</th><th>头像/昵称</th><th>手机号</th><th>注册时间</th><th>状态</th><th>操作</th></tr>
                                </thead>
                                <tbody id="tableBody_user"></tbody>
                            </table>
                            <div class="pagination-box" id="pagination_user"></div>
                        </div>

                        <div id="tab-content" class="tab-pane">
                            <table class="table table-hover">
                                <thead>
                                    <tr><th>日志ID</th><th>操作人</th><th>操作类型</th><th>详情描述</th><th>时间</th></tr>
                                </thead>
                                <tbody id="tableBody_content"></tbody>
                            </table>
                            <div class="pagination-box" id="pagination_content"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <script th:src="@{/js/jquery.min.js(v=2.1.4)}"></script>
    <script th:src="@{/js/bootstrap.min.js(v=3.3.6)}"></script>
    <script th:src="@{/js/echarts.min.js}"></script>

    <script>
        $(document).ready(function() {
            // 时间更新
            var now = new Date();
            $('#updateTime').text(now.getHours() + ':' + (now.getMinutes()<10?'0':'') + now.getMinutes());

            // 初始化图表
            initCharts();
            
            // 初始化三个表格的分页数据
            initAllTables();

            // 获取用户数量
            loadUserCount();
            
            // 获取当日内容发布数量
            loadTodayPostCount();
            
            // 获取待处理举报数量
            loadPendingReportCount();
            
            // 获取已封禁账号数量
            loadBannedUserCount();
            
            // 加载图表数据
            loadChartData();
            
            // 加载风险雷达图数据
            loadRiskChartData();
            
            // 加载内容板块热度图数据
            loadCategoryChartData();
            
            // 加载用户性别构成图数据
            loadUserGenderChartData();

            $(window).resize(function() { resizeCharts(); });
        });

        // 加载用户数量
        function loadUserCount() {
            $.ajax({
                url: '/api/dashboard/userCount',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        var count = response.count || 0;
                        // 格式化数字，添加千位分隔符
                        var formattedCount = count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        $('#userCountValue').text(formattedCount);
                    } else {
                        $('#userCountValue').text('0');
                        console.error('获取用户数量失败:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#userCountValue').text('0');
                    console.error('获取用户数量请求失败:', error);
                }
            });
        }

        // 加载当日内容发布数量
        function loadTodayPostCount() {
            $.ajax({
                url: '/api/dashboard/todayPostCount',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        var count = response.count || 0;
                        // 格式化数字，添加千位分隔符
                        var formattedCount = count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        $('#todayPostCountValue').text(formattedCount);
                    } else {
                        $('#todayPostCountValue').text('0');
                        console.error('获取当日内容发布数量失败:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#todayPostCountValue').text('0');
                    console.error('获取当日内容发布数量请求失败:', error);
                }
            });
        }

        // 加载待处理举报数量
        function loadPendingReportCount() {
            $.ajax({
                url: '/api/dashboard/pendingReportCount',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        var count = response.count || 0;
                        // 格式化数字，添加千位分隔符
                        var formattedCount = count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        $('#pendingReportCountValue').text(formattedCount);
                    } else {
                        $('#pendingReportCountValue').text('0');
                        console.error('获取待处理举报数量失败:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#pendingReportCountValue').text('0');
                    console.error('获取待处理举报数量请求失败:', error);
                }
            });
        }

        // 加载已封禁账号数量
        function loadBannedUserCount() {
            $.ajax({
                url: '/api/dashboard/bannedUserCount',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        var count = response.count || 0;
                        // 格式化数字，添加千位分隔符
                        var formattedCount = count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        $('#bannedUserCountValue').text(formattedCount);
                    } else {
                        $('#bannedUserCountValue').text('0');
                        console.error('获取已封禁账号数量失败:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#bannedUserCountValue').text('0');
                    console.error('获取已封禁账号数量请求失败:', error);
                }
            });
        }

        // ================== 1. 通用分页逻辑系统 (核心功能) ==================
        
        // 模拟数据源
        const db = {
            reports: Array.from({length: 45}, (_, i) => ({
                id: 1000 + i,
                status: i % 3 === 0 ? 'wait' : 'done',
                type: ['广告推广', '人身攻击', '色情低俗', '政治敏感'][i % 4],
                content: `用户发布的第 ${i} 条内容涉嫌违规...`,
                time: '2025-12-' + (10 + i%20),
                result: i % 3 === 0 ? '等待审核' : (i % 5 === 0 ? '账号封禁' : '已删除'),
            })),
            users: Array.from({length: 30}, (_, i) => ({
                uid: 8000 + i,
                name: `User_${i}`,
                avatar: `https://ui-avatars.com/api/?name=User+${i}&background=random`,
                phone: `138${String(i).padStart(8, '0')}`,
                regTime: '2025-12-' + (1 + i%15),
                status: i % 10 === 0 ? 'banned' : 'active'
            })),
            logs: Array.from({length: 50}, (_, i) => ({
                logId: 5000 + i,
                admin: ['Admin', 'XiaoNing', 'System'][i % 3],
                action: ['删除帖子', '封禁用户', '审核通过', '修改配置'][i % 4],
                detail: `对 ID:${100+i} 进行了操作`,
                time: `12-${10+i%20} 10:${i%60}`
            }))
        };

        // 分页状态管理
        const pageState = {
            report: { current: 1, size: 5, data: db.reports },
            user: { current: 1, size: 5, data: db.users },
            content: { current: 1, size: 5, data: db.logs }
        };

        function initAllTables() {
            renderGenericTable('report');
            renderGenericTable('user');
            renderGenericTable('content');
        }

        // 通用渲染函数
        function renderGenericTable(type) {
            const state = pageState[type];
            const start = (state.current - 1) * state.size;
            const end = start + state.size;
            const pageData = state.data.slice(start, end);
            const $tbody = $(`#tableBody_${type}`);
            
            $tbody.empty();

            pageData.forEach(item => {
                let html = '';
                
                // 根据类型渲染不同的行结构
                if (type === 'report') {
                    const statusBadge = item.status === 'wait' 
                        ? '<span class="badge-status badge-wait">待处理</span>' 
                        : '<span class="badge-status badge-done">已处理</span>';
                    const resColor = item.result === '等待审核' ? 'text-warning' : (item.result.includes('封禁') ? 'text-danger' : 'text-success');
                    
                    html = `<tr>
                        <td><b>#${item.id}</b></td>
                        <td>${statusBadge}</td>
                        <td><span class="label label-default">${item.type}</span></td>
                        <td>${item.content}</td>
                        <td>${item.time}</td>
                        <td class="${resColor}">${item.result}</td>
                        <td>
                            <button class="btn btn-xs btn-white"><i class="fa fa-eye"></i></button>
                            ${item.status === 'wait' ? '<button class="btn btn-xs btn-primary">处理</button>' : ''}
                        </td>
                    </tr>`;
                } 
                else if (type === 'user') {
                    const statusBadge = item.status === 'active' 
                        ? '<span class="badge-status badge-done">正常</span>' 
                        : '<span class="badge-status badge-ban">封禁</span>';
                    
                    html = `<tr>
                        <td>${item.uid}</td>
                        <td><img src="${item.avatar}" class="avatar-sm"> <b>${item.name}</b></td>
                        <td>${item.phone}</td>
                        <td>${item.regTime}</td>
                        <td>${statusBadge}</td>
                        <td><button class="btn btn-xs btn-white">详情</button></td>
                    </tr>`;
                }
                else if (type === 'content') {
                    html = `<tr>
                        <td class="text-muted">${item.logId}</td>
                        <td><b>${item.admin}</b></td>
                        <td><span class="text-navy">${item.action}</span></td>
                        <td>${item.detail}</td>
                        <td><i class="fa fa-clock-o"></i> ${item.time}</td>
                    </tr>`;
                }

                $tbody.append(html);
            });

            renderGenericPagination(type);
        }

        // 通用分页控件渲染
        function renderGenericPagination(type) {
            const state = pageState[type];
            const totalPages = Math.ceil(state.data.length / state.size);
            const $container = $(`#pagination_${type}`);
            
            let btns = '';
            // 上一页
            btns += `<button onclick="changePage('${type}', ${state.current - 1})" ${state.current === 1 ? 'disabled' : ''}><</button>`;
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                // 简单的页码显示逻辑，实际项目中可能需要折叠页码
                if (totalPages > 7 && Math.abs(state.current - i) > 2 && i !== 1 && i !== totalPages) continue; 
                btns += `<button class="${i === state.current ? 'active' : ''}" onclick="changePage('${type}', ${i})">${i}</button>`;
            }
            // 下一页
            btns += `<button onclick="changePage('${type}', ${state.current + 1})" ${state.current === totalPages ? 'disabled' : ''}>></button>`;

            const startIdx = (state.current - 1) * state.size + 1;
            const endIdx = Math.min(state.current * state.size, state.data.length);

            $container.html(`
                <div class="page-info">显示 ${startIdx} - ${endIdx} 条，共 ${state.data.length} 条</div>
                <div class="page-btns">${btns}</div>
            `);
        }

        // 切换页面函数 (暴露给全局)
        window.changePage = function(type, page) {
            const state = pageState[type];
            const totalPages = Math.ceil(state.data.length / state.size);
            if (page < 1 || page > totalPages) return;
            
            state.current = page;
            renderGenericTable(type);
        }

        // ================== 2. 图表融合逻辑 ==================
        
        var charts = {};

        // 加载图表数据
        function loadChartData() {
            // 同时加载新增用户、互动量和新增举报数据
            $.when(
                $.ajax({
                    url: '/api/dashboard/last7DaysNewUsers',
                    type: 'GET',
                    dataType: 'json'
                }),
                $.ajax({
                    url: '/api/dashboard/last7DaysInteractions',
                    type: 'GET',
                    dataType: 'json'
                }),
                $.ajax({
                    url: '/api/dashboard/last7DaysNewReports',
                    type: 'GET',
                    dataType: 'json'
                })
            ).done(function(newUsersResponse, interactionsResponse, reportsResponse) {
                var newUsersData = newUsersResponse[0].success ? newUsersResponse[0].data : [];
                var interactionsData = interactionsResponse[0].success ? interactionsResponse[0].data : [];
                var reportsData = reportsResponse[0].success ? reportsResponse[0].data : [];
                console.log('新增用户数据:', newUsersData);
                console.log('互动量数据:', interactionsData);
                console.log('新增举报数据:', reportsData);
                updateTrendChart(newUsersData, interactionsData, reportsData);
            }).fail(function() {
                console.error('加载图表数据失败');
                initCharts([], [], [], []);
            });
        }

        // 更新趋势图表
        function updateTrendChart(newUsersData, interactionsData, reportsData) {
            // 生成最近7天的日期数组（从6天前到今天）
            var dates = [];
            var newUserCounts = [];
            var interactionCounts = [];
            var reportCounts = [];
            var today = new Date();
            
            // 创建日期到数量的映射
            var newUserMap = {};
            var interactionMap = {};
            var reportMap = {};
            
            // 处理新增用户数据
            if (newUsersData && newUsersData.length > 0) {
                newUsersData.forEach(function(item) {
                    var dateKey = String(item.date || item.DATE || item.Date || '').trim();
                    var countValue = item.count !== undefined ? item.count : 
                                   (item.COUNT !== undefined ? item.COUNT : 
                                   (item.Count !== undefined ? item.Count : 0));
                    var count = parseInt(countValue) || parseFloat(countValue) || 0;
                    if (dateKey) {
                        newUserMap[dateKey] = count;
                    }
                });
            }
            
            // 处理互动量数据
            if (interactionsData && interactionsData.length > 0) {
                interactionsData.forEach(function(item) {
                    var dateKey = String(item.date || item.DATE || item.Date || '').trim();
                    var countValue = item.count !== undefined ? item.count : 
                                   (item.COUNT !== undefined ? item.COUNT : 
                                   (item.Count !== undefined ? item.Count : 0));
                    var count = parseInt(countValue) || parseFloat(countValue) || 0;
                    if (dateKey) {
                        interactionMap[dateKey] = count;
                    }
                });
            }
            
            // 处理新增举报数据
            if (reportsData && reportsData.length > 0) {
                reportsData.forEach(function(item) {
                    var dateKey = String(item.date || item.DATE || item.Date || '').trim();
                    var countValue = item.count !== undefined ? item.count : 
                                   (item.COUNT !== undefined ? item.COUNT : 
                                   (item.Count !== undefined ? item.Count : 0));
                    var count = parseInt(countValue) || parseFloat(countValue) || 0;
                    if (dateKey) {
                        reportMap[dateKey] = count;
                    }
                });
            }
            
            // 生成最近7天的日期和对应的数量
            for (var i = 6; i >= 0; i--) {
                var date = new Date(today);
                date.setDate(date.getDate() - i);
                var dateStr = (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                              date.getDate().toString().padStart(2, '0');
                dates.push(dateStr);
                newUserCounts.push(newUserMap[dateStr] || 0);
                interactionCounts.push(interactionMap[dateStr] || 0);
                reportCounts.push(reportMap[dateStr] || 0);
            }
            
            console.log('最终日期数组:', dates);
            console.log('最终新增用户数量:', newUserCounts);
            console.log('最终互动量:', interactionCounts);
            console.log('最终新增举报数量:', reportCounts);
            
            // 更新图表
            initCharts(dates, newUserCounts, interactionCounts, reportCounts);
        }

        function initCharts(dates, newUserCounts, interactionCounts, reportCounts) {
            // Chart 1: 流量与互动趋势 (融合 stats_user 和 stats_content)
            charts.main = echarts.init(document.getElementById('mainTrendChart'));
            
            // 如果没有数据，使用默认的最近7天日期
            if (!dates || dates.length === 0) {
                var today = new Date();
                dates = [];
                for (var i = 6; i >= 0; i--) {
                    var date = new Date(today);
                    date.setDate(date.getDate() - i);
                    var dateStr = (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                                  date.getDate().toString().padStart(2, '0');
                    dates.push(dateStr);
                }
                newUserCounts = [0, 0, 0, 0, 0, 0, 0];
                interactionCounts = [0, 0, 0, 0, 0, 0, 0];
                reportCounts = [0, 0, 0, 0, 0, 0, 0];
            }
            
            // 如果没有提供互动量数据，使用默认值
            if (!interactionCounts || interactionCounts.length === 0) {
                interactionCounts = [0, 0, 0, 0, 0, 0, 0];
            }
            
            // 如果没有提供新增举报数据，使用默认值
            if (!reportCounts || reportCounts.length === 0) {
                reportCounts = [0, 0, 0, 0, 0, 0, 0];
            }
            
            charts.main.setOption({
                tooltip: { trigger: 'axis' },
                legend: { data: ['当日新增用户 (New Users)', '互动量 (Interaction)', '新增举报 (Report)'], bottom: 0 },
                grid: { top: '10%', left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', data: dates, boundaryGap: false },
                yAxis: { 
                    type: 'value',
                    min: 0,
                    max: 10,
                    interval: 1
                },
                series: [
                    {
                        name: '当日新增用户 (New Users)', type: 'line', smooth: true,
                        itemStyle: { color: '#4f46e5' },
                        areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: '#4f46e544'}, {offset: 1, color: '#4f46e500'}]) },
                        data: newUserCounts
                    },
                    {
                        name: '互动量 (Interaction)', type: 'line', smooth: true,
                        itemStyle: { color: '#10b981' },
                        data: interactionCounts
                    },
                    {
                        name: '新增举报 (Report)', type: 'bar', barWidth: 10,
                        itemStyle: { color: '#ef4444' },
                        data: reportCounts
                    }
                ]
            });

            // Chart 2: 风险雷达 (来自 report_stats)
            initRiskChart();

            // Chart 3: 内容板块饼图 (来自 content_stats)
            // 不在这里初始化，等数据加载完成后再初始化

            // Chart 4: 用户性别 (来自 user_stats)
            // 不在这里初始化，等数据加载完成后再初始化

            // Chart 5: 处理结果 (来自 report_stats)
            charts.res = echarts.init(document.getElementById('resultBarChart'));
            charts.res.setOption({
                tooltip: { trigger: 'axis' },
                grid: { top: '10%', bottom: '15%', left: '15%' },
                xAxis: { type: 'category', data: ['删帖', '封号', '驳回', '警告'] },
                yAxis: { type: 'value' },
                series: [{
                    type: 'bar', data: [120, 20, 50, 80],
                    itemStyle: { color: '#f59e0b', borderRadius: [4, 4, 0, 0] }
                }]
            });
        }

        // 加载风险雷达图数据
        function loadRiskChartData() {
            $.ajax({
                url: '/api/dashboard/reportTypeCounts',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data) {
                        updateRiskChart(response.data);
                    } else {
                        console.error('获取各类型举报数量失败:', response.message);
                        initRiskChart();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('获取各类型举报数量请求失败:', error);
                    initRiskChart();
                }
            });
        }

        // 更新风险雷达图
        function updateRiskChart(data) {
            // 定义6种举报类型，按照六边形的顺序
            var reportTypes = ['垃圾信息', '色情低俗', '违法违规', '欺诈', '侵权', '其他'];
            var values = [];
            
            // 创建类型到数量的映射
            var typeCountMap = {};
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    var type = String(item.reportType || item.report_type || item.REPORT_TYPE || '').trim();
                    var countValue = item.count !== undefined ? item.count : 
                                   (item.COUNT !== undefined ? item.COUNT : 
                                   (item.Count !== undefined ? item.Count : 0));
                    var count = parseInt(countValue) || parseFloat(countValue) || 0;
                    if (type) {
                        typeCountMap[type] = count;
                    }
                });
            }
            
            // 按照顺序获取各类型的数量
            reportTypes.forEach(function(type) {
                values.push(typeCountMap[type] || 0);
            });
            
            console.log('风险雷达图数据 - 类型:', reportTypes);
            console.log('风险雷达图数据 - 数量:', values);
            
            // 计算最大值（用于设置雷达图的max值）
            var maxValue = Math.max.apply(Math, values);
            maxValue = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 10; // 如果有数据，最大值增加20%的余量，否则默认为10
            
            initRiskChart(reportTypes, values, maxValue);
        }

        // 初始化风险雷达图
        function initRiskChart(reportTypes, values, maxValue) {
            // 默认值
            if (!reportTypes || reportTypes.length === 0) {
                reportTypes = ['垃圾信息', '色情低俗', '违法违规', '欺诈', '侵权', '其他'];
            }
            if (!values || values.length === 0) {
                values = [0, 0, 0, 0, 0, 0];
            }
            if (!maxValue || maxValue <= 0) {
                maxValue = 10;
            }
            
            charts.risk = echarts.init(document.getElementById('riskChart'));
            charts.risk.setOption({
                tooltip: {},
                radar: {
                    indicator: reportTypes.map(function(type) {
                        return { name: type, max: maxValue };
                    }),
                    radius: '65%',
                    center: ['50%', '50%'],
                    shape: 'polygon'
                },
                series: [{
                    type: 'radar',
                    data: [
                        { 
                            value: values, 
                            name: '违规分布', 
                            itemStyle: { color: '#ef4444' }, 
                            areaStyle: { opacity: 0.2 } 
                        }
                    ]
                }]
            });
        }

        // 加载内容板块热度图数据
        function loadCategoryChartData() {
            $.ajax({
                url: '/api/dashboard/categoryPostCounts',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('内容板块热度图API响应:', response);
                    if (response.success && response.data) {
                        console.log('内容板块热度图原始数据:', response.data);
                        updateCategoryChart(response.data);
                    } else {
                        console.error('获取各分类帖子数量失败:', response.message);
                        initCategoryChart();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('获取各分类帖子数量请求失败:', error);
                    console.error('响应内容:', xhr.responseText);
                    initCategoryChart();
                }
            });
        }

        // 更新内容板块热度图
        function updateCategoryChart(data) {
            // 定义4个分类，按照顺序
            var categories = ['动态', '跑腿', '二手集市', '失物招领'];
            var chartData = [];
            
            // 创建分类名称到数量的映射
            var categoryMap = {};
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    var categoryName = String(item.categoryName || item.category_name || item.CATEGORY_NAME || '').trim();
                    var countValue = item.count !== undefined ? item.count : 
                                   (item.COUNT !== undefined ? item.COUNT : 
                                   (item.Count !== undefined ? item.Count : 0));
                    var count = parseInt(countValue) || parseFloat(countValue) || 0;
                    if (categoryName) {
                        categoryMap[categoryName] = count;
                    }
                });
            }
            
            // 按照顺序生成图表数据
            categories.forEach(function(categoryName) {
                chartData.push({
                    value: categoryMap[categoryName] || 0,
                    name: categoryName
                });
            });
            
            console.log('内容板块热度图数据:', chartData);
            console.log('分类映射:', categoryMap);
            
            // 确保图表已初始化
            if (!charts.cat) {
                initCategoryChart(chartData);
            } else {
                // 更新现有图表
                charts.cat.setOption({
                    series: [{
                        data: chartData
                    }]
                }, true); // 使用notMerge=true，完全替换配置
            }
        }

        // 初始化内容板块热度图
        function initCategoryChart(chartData) {
            // 默认值
            if (!chartData || chartData.length === 0) {
                chartData = [
                    { value: 0, name: '动态' },
                    { value: 0, name: '跑腿' },
                    { value: 0, name: '二手集市' },
                    { value: 0, name: '失物招领' }
                ];
            }
            
            // 如果图表已存在，先销毁
            if (charts.cat) {
                charts.cat.dispose();
            }
            
            // 初始化图表
            charts.cat = echarts.init(document.getElementById('categoryChart'));
            charts.cat.setOption({
                tooltip: { trigger: 'item' },
                color: ['#4f46e5', '#10b981', '#f59e0b', '#8b5cf6'],
                series: [{
                    type: 'pie', 
                    radius: ['40%', '70%'],
                    itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 2 },
                    data: chartData
                }]
            }, true); // 使用notMerge=true，完全替换配置
        }

        // 加载用户性别构成图数据
        function loadUserGenderChartData() {
            $.ajax({
                url: '/api/dashboard/userGenderCounts',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log('用户性别构成图API响应:', response);
                    if (response.success && response.data) {
                        console.log('用户性别构成图原始数据:', response.data);
                        updateUserGenderChart(response.data);
                    } else {
                        console.error('获取用户性别统计失败:', response.message);
                        initUserGenderChart();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('获取用户性别统计请求失败:', error);
                    console.error('响应内容:', xhr.responseText);
                    initUserGenderChart();
                }
            });
        }

        // 更新用户性别构成图
        function updateUserGenderChart(data) {
            // 定义性别映射：0未知，1男，2女
            var genderMap = {
                0: { name: '未知', value: 0 },
                1: { name: '男', value: 0 },
                2: { name: '女', value: 0 }
            };
            
            // 处理返回的数据
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    console.log('处理性别数据项:', item);
                    var genderValue = item.gender !== undefined ? item.gender : 
                                    (item.GENDER !== undefined ? item.GENDER : null);
                    var countValue = item.count !== undefined ? item.count : 
                                   (item.COUNT !== undefined ? item.COUNT : 
                                   (item.Count !== undefined ? item.Count : 0));
                    var count = parseInt(countValue) || parseFloat(countValue) || 0;
                    
                    console.log('解析后的性别值:', genderValue, '数量:', count);
                    
                    if (genderValue !== null && genderValue !== undefined) {
                        var gender = parseInt(genderValue);
                        if (genderMap.hasOwnProperty(gender)) {
                            genderMap[gender].value = count;
                            console.log('更新性别映射 - 性别:', gender, '数量:', count);
                        } else {
                            console.warn('未知的性别值:', gender);
                        }
                    }
                });
            } else {
                console.warn('没有返回性别统计数据');
            }
            
            // 转换为数组，按照：男、女、未知的顺序
            var chartData = [
                genderMap[1], // 男
                genderMap[2], // 女
                genderMap[0]  // 未知
            ];
            
            console.log('用户性别构成图最终数据:', chartData);
            console.log('性别映射对象:', genderMap);
            
            // 如果图表不存在，先初始化
            if (!charts.user) {
                console.log('图表不存在，初始化图表');
                initUserGenderChart(chartData);
            } else {
                console.log('图表已存在，更新图表数据');
                // 更新现有图表 - 使用完整的配置确保数据正确更新
                charts.user.setOption({
                    series: [{
                        type: 'pie',
                        radius: '70%',
                        data: chartData
                    }]
                }, true); // 使用notMerge=true，完全替换配置
            }
        }

        // 初始化用户性别构成图
        function initUserGenderChart(chartData) {
            // 默认值
            if (!chartData || chartData.length === 0) {
                chartData = [
                    { value: 0, name: '男' },
                    { value: 0, name: '女' },
                    { value: 0, name: '未知' }
                ];
            }
            
            console.log('初始化用户性别构成图，数据:', chartData);
            
            // 如果图表已存在，先销毁
            if (charts.user) {
                charts.user.dispose();
                charts.user = null;
            }
            
            // 初始化图表
            var chartDom = document.getElementById('userPieChart');
            if (!chartDom) {
                console.error('找不到userPieChart元素');
                return;
            }
            
            charts.user = echarts.init(chartDom);
            charts.user.setOption({
                tooltip: { trigger: 'item' },
                color: ['#3b82f6', '#ec4899', '#9ca3af'],
                series: [{
                    type: 'pie', 
                    radius: '70%',
                    data: chartData,
                    label: {
                        show: true,
                        formatter: '{b}: {c}'
                    }
                }]
            }, true); // 使用notMerge=true，完全替换配置
            
            console.log('用户性别构成图初始化完成');
        }

        function resizeCharts() {
            for (let key in charts) {
                charts[key].resize();
            }
        }
    </script>
</body>
</html>